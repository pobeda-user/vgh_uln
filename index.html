<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ВГХ Ульяновск</title>
    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" href="./styles.css" />
    <meta name="theme-color" content="#050915" />
  </head>
  <body>
    <div id="netIndicator" class="netIndicator online" aria-hidden="true"></div>
    <div id="offlineBadge" class="pill" hidden>OFFLINE</div>

    <div class="container">
      <header id="mainHeader" class="header" style="display:none">
        <div class="header-content" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div class="brand" style="display:flex;gap:12px;align-items:center">
            <div class="logo" aria-hidden="true"><img src="./icon.svg" alt="" style="width:22px;height:22px" /></div>
            <div>
              <h1 style="margin:0">ВГХ Ульяновск</h1>
              <p class="sub" style="margin:0">PWA + Telegram</p>
            </div>
          </div>
          <!-- app.js will inject headerUserName + logoutBtn here if missing -->
        </div>
      </header>

      <section id="loginScreen" class="screen" style="display:none">
        <div class="auth-card">
          <h2>Вход</h2>
          <form id="loginForm" class="grid" autocomplete="on">
            <div class="field full">
              <span>Логин</span>
              <input name="login" required />
            </div>
            <div class="field full">
              <span>Пароль</span>
              <input name="password" type="password" required />
            </div>
            <div class="field full">
              <button type="submit">Войти</button>
            </div>
          </form>
          <button id="showRegistrationBtn" type="button" class="btn-link">Регистрация через Telegram</button>
          <div id="status" class="sub" style="margin-top:10px"></div>
        </div>
      </section>

      <section id="registrationScreen" class="screen" style="display:none">
        <div class="auth-card">
          <h2>Регистрация</h2>
          <p class="sub">Регистрация выполняется только через Telegram-бота.</p>
          <button id="showLoginBtn" type="button" class="btn-link">Назад ко входу</button>
        </div>
      </section>

      <section id="requestForm" class="screen" style="display:none">
        <div class="card">
          <div class="labelRow">
            <div style="font-weight:800">Форма ВГХ</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="personalCabinetBtn" type="button" class="header-btn">Личный кабинет</button>
              <button id="installBtn" type="button" class="header-btn">Установить</button>
              <button id="clearCacheBtn" type="button" class="header-btn">Сброс кеша</button>
            </div>
          </div>

          <form id="requestForm" class="grid">
            <div class="field"><span>Поставщик</span><input name="supplier" required /></div>
            <div class="field"><span>Тип товара</span><input name="product_type" required /></div>
            <div class="field"><span>ЛК</span><input name="lk" required /></div>
            <div class="field"><span>Наименование товара</span><input name="product_name" /></div>

            <div class="field"><span>Длина (см)</span><input name="d_cm" data-digits-only="true" required /></div>
            <div class="field"><span>Ширина (см)</span><input name="w_cm" data-digits-only="true" required /></div>
            <div class="field"><span>Высота (см)</span><input name="h_cm" data-digits-only="true" required /></div>
            <div class="field"><span>Вес (кг)</span><input name="weight_kg" required /></div>

            <div class="field"><span>ТПР2</span><input name="tpr2" data-number-only="true" /></div>
            <div class="field"><span>ТПР3</span><input name="tpr3" data-number-only="true" required /></div>
            <div class="field"><span>ТПР4</span><input name="tpr4" data-number-only="true" required /></div>
            <div class="field"><span>СГ (дней)</span><input name="sg_days" data-number-only="true" required /></div>

            <div class="field"><span>Дата изготовления</span><input name="mfg_date" placeholder="YYYY-MM-DD" /></div>
            <div class="field"><span>Годен до</span><input id="expiryDateOut" readonly /></div>

            <div class="field">
              <span>Процент СГ</span>
              <input id="sgPercent" readonly />
              <button id="calcSgBtn" type="button" class="secondary">Рассчитать</button>
            </div>

            <div class="field full">
              <span>Проблема</span>
              <button id="chooseProblemBtn" type="button" class="secondary">Выбрать проблему</button>
              <div id="problemGrid" class="typeGrid" hidden></div>
              <div id="barcodeNotScanningDetails" hidden>
                <select name="barcode_not_scanning_reason">
                  <option value="">Причина</option>
                  <option value="damaged">Поврежден</option>
                  <option value="no_read">Не читается</option>
                </select>
              </div>
            </div>

            <div class="field full"><span>Комментарий</span><textarea name="comment"></textarea></div>

            <div class="field full">
              <span>Вложения</span>
              <input id="boxAttachments" type="file" multiple />
              <div id="filesHint" class="sub"></div>
            </div>

            <div id="photoBarcodeBlockWrap" class="field full" hidden>
              <span>Фото ШК Блока</span>
              <input id="photoBarcodeBlock" type="file" />
            </div>

            <div class="field full"><button id="submitBtn" type="submit">Отправить</button></div>
          </form>

          <div class="queueCard card">
            <div class="queueHeader">
              <div class="queueTitle">Очередь (offline)</div>
              <button id="flushQueueBtn" type="button" class="header-btn">Отправить очередь</button>
            </div>
            <div id="queueEmpty" class="sub">Очередь пуста</div>
            <ul id="queueList" class="queueList"></ul>
          </div>
        </div>
      </section>

      <section id="personalCabinetScreen" class="screen" style="display:none">
        <div class="card">
          <div class="labelRow">
            <div style="font-weight:800">Личный кабинет</div>
            <button type="button" class="header-btn" onclick="showMainApp()">К форме</button>
          </div>
          <div id="requestsList" class="requests-list" style="margin-top:12px"></div>
        </div>
      </section>

      <section id="adminCabinetScreen" class="screen" style="display:none">
        <div class="card">
          <div class="labelRow"><div style="font-weight:800">Админский кабинет</div></div>
          <div class="admin-stats">
            <div class="request-item"><div class="request-meta">Всего заявок</div><div id="totalRequests" class="request-id">0</div></div>
            <div class="request-item"><div class="request-meta">Новых</div><div id="newRequests" class="request-id">0</div></div>
            <div class="request-item"><div class="request-meta">В работе</div><div id="inProgressRequests" class="request-id">0</div></div>
          </div>
          <div id="adminRequestsList" class="admin-requests-list"></div>
        </div>
      </section>

      <div id="successModal" hidden>
        <div class="card">
          <div class="labelRow">
            <div style="font-weight:800">Готово</div>
            <button data-action="close" type="button" class="header-btn">Закрыть</button>
          </div>
          <p class="sub">Заявка отправлена.</p>
          <button id="successModalOkBtn" type="button">OK</button>
        </div>
      </div>

      <div id="toastHost" class="toastHost"></div>
    </div>

    <script src="./app.js"></script>
  </body>
</html>
